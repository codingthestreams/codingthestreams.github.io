<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Rearchitecting Apache Pulsar to handle 100 million topics, Part 3 | Coding the Streams - tech blog by Lari Hotari</title>
<meta name="generator" content="Jekyll v3.9.2">
<meta property="og:title" content="Rearchitecting Apache Pulsar to handle 100 million topics, Part 3">
<meta property="og:locale" content="en_US">
<meta name="description" content="Context">
<meta property="og:description" content="Context">
<link rel="canonical" href="https://codingthestreams.com/pulsar/2022/11/28/rearchitecting-pulsar-part-3.html">
<meta property="og:url" content="https://codingthestreams.com/pulsar/2022/11/28/rearchitecting-pulsar-part-3.html">
<meta property="og:site_name" content="Coding the Streams - tech blog by Lari Hotari">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-11-28T15:31:07+00:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Rearchitecting Apache Pulsar to handle 100 million topics, Part 3">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-11-28T15:31:07+00:00","datePublished":"2022-11-28T15:31:07+00:00","description":"Context","headline":"Rearchitecting Apache Pulsar to handle 100 million topics, Part 3","mainEntityOfPage":{"@type":"WebPage","@id":"https://codingthestreams.com/pulsar/2022/11/28/rearchitecting-pulsar-part-3.html"},"url":"https://codingthestreams.com/pulsar/2022/11/28/rearchitecting-pulsar-part-3.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
<link type="application/atom+xml" rel="alternate" href="https://codingthestreams.com/feed.xml" title="Coding the Streams - tech blog by Lari Hotari">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-71LP6Z9K0H"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-71LP6Z9K0H');
</script>
  


</head>
<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Coding the Streams - tech blog by Lari Hotari</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/about/">About</a><div class="categories-menu page-link">Categories
<ul>
  
    <li>
      <a href="https://codingthestreams.com/category/pulsar">pulsar</a>
    </li>
  
    <li>
      <a href="https://codingthestreams.com/category/eventdriven">eventdriven</a>
    </li>
  
    <li>
      <a href="https://codingthestreams.com/category/til">til</a>
    </li>
  
</ul>
</div>
<div class="categories-menu page-link">Tags
<ul>
    
      <li>
        <a href="https://codingthestreams.com/tag/pulsar-ng">pulsar-ng</a>
      </li>
    
      <li>
        <a href="https://codingthestreams.com/tag/availability">availability</a>
      </li>
    
      <li>
        <a href="https://codingthestreams.com/tag/pulsar-dev">pulsar-dev</a>
      </li>
    
      <li>
        <a href="https://codingthestreams.com/tag/slo">slo</a>
      </li>
    
</ul>
</div>

        </div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Rearchitecting Apache Pulsar to handle 100 million topics, Part 3</h1>
    <p class="post-meta"><time class="dt-published" datetime="2022-11-28T15:31:07+00:00" itemprop="datePublished">
        Nov 28, 2022
      </time></p>
      Tags: <a href="/tag/pulsar-ng.html" rel="tag">pulsar-ng</a>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#context">Context</a></li>
<li class="toc-entry toc-h2">
<a href="#results-from-experimenting-with-apache-ratis-and-the-sharding-model">Results from experimenting with Apache Ratis and the sharding model</a>
<ul>
<li class="toc-entry toc-h3"><a href="#performance-in-local-tests">Performance in local tests</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#next-experiments--milestones-on-the-way-toward">Next experiments / milestones on the way toward</a>
<ul>
<li class="toc-entry toc-h3"><a href="#minimal-implementation-to-integrate-the-new-metadata-layer-to-pulsar">Minimal implementation to integrate the new metadata layer to Pulsar</a></li>
<li class="toc-entry toc-h3"><a href="#topic-assignment-flow">Topic assignment flow</a></li>
<li class="toc-entry toc-h3"><a href="#topic-handover-flow">Topic handover flow</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#summary">Summary</a></li>
</ul>
<h2 id="context">
<a class="anchor" href="#context" aria-hidden="true"><span class="octicon octicon-link"></span></a>Context</h2>

<p>Welcome to continue to read about the possible design for rearchitecting Apache Pulsar to handle 100 million topics.</p>

<p>The <a href="/pulsar/2022/10/24/rearchitecting-pulsar-part-2.html">previous blog post explains the context</a>.</p>

<h2 id="results-from-experimenting-with-apache-ratis-and-the-sharding-model">
<a class="anchor" href="#results-from-experimenting-with-apache-ratis-and-the-sharding-model" aria-hidden="true"><span class="octicon octicon-link"></span></a>Results from experimenting with Apache Ratis and the sharding model</h2>

<p>The goal of the first set of experiments was about validating the feasibility of Apache Ratis for the “metadata shard” layer.
It was mainly about learning the role of distributed consensus for ensuring strong consistency and learning about the implementation tradeoffs and limitations.</p>

<p>There was a goal to demonstrate the creation of 100000 topics across 5 shards. This was more like a simulation and it didn’t follow the Pulsar model closely since the main goal was to learn about the characteristics and practical details of implementing the metadata layer with an event driven approach.</p>

<p>The first experiment with Apache Ratis was completed and the code is available in https://github.com/lhotari/pulsar-ng-experiment-1 .</p>

<h3 id="performance-in-local-tests">
<a class="anchor" href="#performance-in-local-tests" aria-hidden="true"><span class="octicon octicon-link"></span></a>Performance in local tests</h3>

<p>The latency of adding a new entry to the Raft log is around 2-3 milliseconds. The throughput of about 300 to 500 ops/second is significantly lower than the <a href="https://www.slideshare.net/Hadoop_Summit/high-throughput-data-replication-over-raft/30">10000 IOPS mentioned in a slide deck</a>. Perhaps 10000 IOPS is across multiple Raft groups?
With batching, the latency stays fairly low when increasing the batch size. Adding 100000 topics in the experiment completes in a few seconds when using batching across 5 shards. 
The throughput could also be increased with pipelining, by having multiple requests in flight at a time. This hasn’t been done in the experiment.</p>

<h2 id="next-experiments--milestones-on-the-way-toward">
<a class="anchor" href="#next-experiments--milestones-on-the-way-toward" aria-hidden="true"><span class="octicon octicon-link"></span></a>Next experiments / milestones on the way toward</h2>

<p>The main goal is to integrate the new architecture to real Pulsar broker so that we can learn about the gaps in the solution.
This is about following <a href="https://wiki.c2.com/?WalkingSkeleton">“walking skeleton”</a> and <a href="https://wiki.c2.com/?TracerBullets">“tracer bullets”</a> development strategies to kick start development and let the feedback guide further development.
The main focus would be on the “happy path” when implementing the walking skeleton.</p>

<h3 id="minimal-implementation-to-integrate-the-new-metadata-layer-to-pulsar">
<a class="anchor" href="#minimal-implementation-to-integrate-the-new-metadata-layer-to-pulsar" aria-hidden="true"><span class="octicon octicon-link"></span></a>Minimal implementation to integrate the new metadata layer to Pulsar</h3>

<p>In the new architecture, the lookup and admin layer are separated from the brokers. 
One possible way to start moving forward is to start the “lookup component” based on pulsar-discovery component which was removed by <a href="https://github.com/apache/pulsar/pull/12119">PR #12119</a>.</p>

<p>The Pulsar documentation contains a description of the <a href="https://pulsar.apache.org/docs/2.10.x/developing-binary-protocol#topic-lookup">topic lookup</a>. There’s no need to modify the existing binary protocol to support the new architecture.
It’s possible that there’s no need to have a separate redirect step in the lookup.</p>

<p>Here are some on the essential use cases to support for the admin layer and the lookups.</p>

<ul>
  <li>Minimal Admin API implementation against the new metadata layer
    <ul>
      <li>Create, delete, list tenants</li>
      <li>Create, delete, list namespaces</li>
      <li>Create, delete, list topics</li>
    </ul>
  </li>
  <li>Minimal topic lookup layer so that a Pulsar client can perform lookups
    <ul>
      <li>In the new architecture, the topic lookup will trigger the topic assignment.
        <ul>
          <li>Lookup is part of the “topic assignment flow”</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>What do we mean with a “flow”? This is some type of end-to-end usage flow. Externally, the topic lookup flow is visible to the client application. Internally there’s a topic assignment flow that must be implemented.
When focusing on the flow, we are also following the principle of “form follows function”.</p>

<h3 id="topic-assignment-flow">
<a class="anchor" href="#topic-assignment-flow" aria-hidden="true"><span class="octicon octicon-link"></span></a>Topic assignment flow</h3>

<p>As part of the topic lookup flow, the topic will get assigned to a particular broker.<br>
It will be necessary to describe the components and the interactions in the assignment flow.</p>

<h3 id="topic-handover-flow">
<a class="anchor" href="#topic-handover-flow" aria-hidden="true"><span class="octicon octicon-link"></span></a>Topic handover flow</h3>

<p>One of the main reasons for the new architecture is to support per-topic state so that topic unloading can be handled in a way where the topic is handed over from one broker to another in a seamless way.
This is another flow to start working on together with the topic assignment flow.</p>

<h2 id="summary">
<a class="anchor" href="#summary" aria-hidden="true"><span class="octicon octicon-link"></span></a>Summary</h2>

<p>This blog post was a short update on the experiment with Ratis and it explains the high level plan forward.
Future blog posts in this series will provide more clarity and details.</p>

  </div>

  
  <div>
    <h3>Related Posts</h3>
    <ul>
    
      <li><a href="/pulsar/2023/03/02/scalable-distributed-system-principles.html">Scalable distributed system principles in the context of redesigning Apache Pulsar's metadata solution</a></li>
    
      <li><a href="/pulsar/2022/11/29/rearchitecting-pulsar-part-4.html">Rearchitecting Apache Pulsar to handle 100 million topics, Part 4</a></li>
    
      <li><a href="/pulsar/2022/10/24/rearchitecting-pulsar-part-2.html">Rearchitecting Apache Pulsar to handle 100 million topics, Part 2</a></li>
    
      <li><a href="/pulsar/2022/10/21/possible-high-level-architecture.html">Rearchitecting Apache Pulsar to handle 100 million topics, Part 1</a></li>
    
      <li><a href="/pulsar/2022/10/18/view-of-pulsar-metadata-store.html">A critical view of Pulsar's Metadata store abstraction</a></li>
    
      <li><a href="/pulsar/2022/10/17/namespace-bundle-is-a-limiting-factor.html">Pulsar's namespace bundle centric architecture limits future options</a></li>
    
      <li><a href="/pulsar/2022/10/14/pulsars-promise.html">Pulsar's high availability promise and its blind spot</a></li>
    
      <li><a href="/pulsar/eventdriven/2022/10/14/high-availability-for-event-driven-systems.html">How do you define high availability in your event driven system?</a></li>
    
      <li><a href="/pulsar/2022/10/14/not-about-pulsar-3-0.html">Correction: This blog is not about Apache Pulsar 3.0</a></li>
    
      <li><a href="/pulsar/2022/10/13/possible-worlds-for-apache-pulsar.html">Possible worlds for Apache Pulsar 3.0 and making that actual</a></li>
    
    </ul>
  </div>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://codingthestreams.com/pulsar/2022/11/28/rearchitecting-pulsar-part-3.html';
      this.page.identifier = 'https://codingthestreams.com/pulsar/2022/11/28/rearchitecting-pulsar-part-3.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://codingthestreams.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
<a class="u-url" href="/pulsar/2022/11/28/rearchitecting-pulsar-part-3.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Coding the Streams - tech blog by Lari Hotari</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Coding the Streams - tech blog by Lari Hotari</li>
<li><a class="u-email" href="mailto:lhotari@apache.org">lhotari@apache.org</a></li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list">
<li><a href="https://github.com/lhotari"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">lhotari</span></a></li>
<li><a href="https://www.twitter.com/lhotari"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">lhotari</span></a></li>
</ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Blogs and experiments about event streaming by Lari Hotari and guest authors.  The opinions are my own and do not represent the views of my employer or Apache Software Foundation (ASF) or Apache Pulsar PMC.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
